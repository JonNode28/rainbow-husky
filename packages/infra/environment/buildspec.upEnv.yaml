version: 0.2
env:
  shell: bash

phases:
  install:
    commands:
      - export FORCE_COLOR=0
      - yarn install --immutable

  build:
    commands:
      - export PATH="/root/.pulumi/bin:$PATH"
      - pulumi login s3://${PULUMI_STATE_S3_BUCKET}
      - cd packages/infra/environment
      - BRANCH_NAME=$(echo $CODEBUILD_WEBHOOK_HEAD_REF | cut -d'/' -f 3) # get feature branch name
      - export PULUMI_CONFIG_PASSPHRASE=
      - |
        if [ "$CODEBUILD_WEBHOOK_EVENT" != "PULL_REQUEST_UPDATED" ]; then
          echo Initialising $BRANCH_NAME stack
          pulumi stack init $BRANCH_NAME
        fi
      - echo Selecting $BRANCH_NAME stack
      - pulumi stack select $BRANCH_NAME
      - echo Applying changes to $BRANCH_NAME stack
      - pulumi up --skip-preview
